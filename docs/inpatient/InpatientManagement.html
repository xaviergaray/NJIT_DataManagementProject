<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NMA - In-patient Management</title>
    <link rel="stylesheet" type="text/css" href="../styles.css">
    <style>
        .scrollBoxContainer {
            display: inline-block;
            width: auto;
            height: 80vh;

        }

        /* CSS for the scroll box */
        #scrollBox {
            overflow: auto;
            height: 100%;
        }

        /* CSS for the table */
        #databaseItems {
            border-collapse: separate;
            border-spacing: 2em;  /* Increase this value to increase spacing */
            table-layout: auto;
        }

        #databaseItems th, #databaseItems td {
            text-align: center;
        }

        /* CSS for the sticky header */
        #databaseItems th {
            position: sticky;
            top: 0;
            background: white;  /* Change this to match your table's background color */
        }

        h3 {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Newark Medical Associates</h1>
        <h2>In-patient Management</h2>

        <div class="scrollBoxContainer">
            <h3>Room Availability</h3>
            <div id="scrollBox">
                <table id="databaseItems">
                    <thead>
                        <tr>
                            <th>ID <button class="sort-btn" data-sort="ID">Sort</button></th>
                            <th>Nursing Unit <button class="sort-btn" data-sort="NursingUnit">Sort</button></th>
                            <th>Wing <button class="sort-btn" data-sort="Wing">Sort</button></th>
                            <th>Room Number <button class="sort-btn" data-sort="RoomNumber">Sort</button></th>
                            <th>Bed Number <button class="sort-btn" data-sort="BedNumber">Sort</button></th>
                            <th>Assigned Patient <button class="sort-btn" data-sort="AssignedPatient">Sort</button></th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows from the database will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
       window.onload = async function() {
        var databaseItems = document.getElementById('databaseItems');

        let responseBeds = await fetch('/get-beds');
        let beds = await responseBeds.json();

        // Fetch all patients and store them in a map for quick lookup
        let responsePatients = await fetch('/get-patients');
        let patients = await responsePatients.json();
        let patientMap = {};
        for (let patient of patients) {
            patientMap[patient.BedID] = patient;
        }

        // Function to populate the table with data
        function populateTable(data) {
            // Clear the table first
            databaseItems.querySelector('tbody').innerHTML = '';

            for (var i = 0; i < data.length; i++) {
                var row = document.createElement('tr');

                var idCell = document.createElement('td');
                idCell.textContent = data[i].ID;
                row.appendChild(idCell);

                var nursingUnitCell = document.createElement('td');
                nursingUnitCell.textContent = data[i].NursingUnit;
                row.appendChild(nursingUnitCell);

                var wingCell = document.createElement('td');
                wingCell.textContent = data[i].Wing;
                row.appendChild(wingCell);

                var roomNumberCell = document.createElement('td');
                roomNumberCell.textContent = data[i].RoomNumber;
                row.appendChild(roomNumberCell);

                var bedNumberCell = document.createElement('td');
                bedNumberCell.textContent = data[i].BedNumber;
                row.appendChild(bedNumberCell);

                var patient = patientMap[data[i].ID];
                var patientCell = document.createElement('td');
                patientCell.textContent = patient ? patient.Name : 'No patient assigned';
                row.appendChild(patientCell);

                databaseItems.querySelector('tbody').appendChild(row);
            }
        }

        // Initial population of the table
        populateTable(beds);
           
        // Add event listeners to the sort buttons
        var sortButtons = document.querySelectorAll('.sort-btn');
        sortButtons.forEach(function(btn) {
            var ascending = true;  // Variable to toggle the sort order

            btn.addEventListener('click', function() {
                var sortField = this.dataset.sort;

                // Sort the data
                beds.sort(function(a, b) {
                    // If sorting by 'AssignedPatient', use the patient data
                    if (sortField === 'AssignedPatient') {
                        var patientA = patientMap[a.ID] ? patientMap[a.ID].Name : '';
                        var patientB = patientMap[b.ID] ? patientMap[b.ID].Name : '';
                        var comparison = ascending ? patientA.localeCompare(patientB) : patientB.localeCompare(patientA);
                        if (comparison !== 0) return comparison;
                    } else {
                        // Otherwise, use the bed data
                        if (a[sortField] !== b[sortField]) {
                            return ascending ? (a[sortField] < b[sortField] ? -1 : 1) : (a[sortField] > b[sortField] ? -1 : 1);
                        }
                    }

                    // If the fields match, sub-sort by 'ID'
                    return a.ID - b.ID;
                });

                // Toggle the sort order for the next click
                ascending = !ascending;

                // Repopulate the table with the sorted data
                populateTable(beds);
            });
        });

    };

    </script>
</body>
</html>
